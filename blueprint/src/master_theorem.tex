\section{The Master theorem}

Analyzing the time complexity of algorithms, especially recursive ones, is more often 
than not a non-trivial task. For a recursive algorithm, its time complexity can be 
written as a recurrence formula, which is generally not easy, sometimes even impossible 
to solve with a closed formula. In some cases, though, we can find asymptotic bounds 
of the solution, despite not being able to necessarily find the 
precise solution to the recurrence. One large class of such cases is the class of 
divide-and-conquer algorithms, i.e. algorithms that recursively split the
problem into smaller, similarly-sized subproblems. The Master theorem puts asymptotic 
bounds on divide-and-conquer recurrences.

\begin{theorem}[Master theorem for divide-and-conquer recurrences]
    Let $T f : \mathbb{N} \rightarrow \mathbb{N}$ be functions such that the recurrence
    \[
        T(n) = a T(n/b) + f(n)
    \]
    holds for some $a > 0$ and $b > 1$. Let also $f(n) \in \Theta(n^d)$ for some $d \ge 1$. 
    Then the following holds:
    \begin{enumerate}
        \item if $a < b^d$, then $T(n) \in \Theta(n^d)$,
        \item if $a = b^d$, then $T(n) \in \Theta(n^d \log_b{n})$ and
        \item if $a > b^d$, then $T(n) \in \Theta(n^{\log_b{a}})$.
    \end{enumerate}
    In the case where $f$ is bounded above by $n^d$ only above or only below,
    $T$ is also bounded only above or only below by the respective function.
\end{theorem}

We prove this theorem by proving all of its cases separately. 

\begin{definition}
    \label{def:upper_master_rec}
    \lean{UpperMasterRec}
    \leanok
    \uses{def:big_o}
    Let $T f : \mathbb{N} \rightarrow \mathbb{N}$ be functions such that $T$ 
    is monotone and the recurrence
    \[
        T(n) \leq a T(\lceil n/b \rceil) + f(n)
    \]
    holds for all $n \ge n\_0$ for some $a > 0$, $n\_0 > 1$ and $b > n\_0$. 
    Let also $f(n) \in O(n^d)$ for some $d \ge 1$. The above recurrence 
    is an \textbf{upper master recurrence} with parameters $(a, n\_0, b, d)$.
\end{definition}

\begin{definition}
    \label{def:lower_master_rec}
    \lean{LowerMasterRec}
    \leanok
    \uses{def:big_omega}
    Let $T f : \mathbb{N} \rightarrow \mathbb{N}$ be functions such that $T$ 
    is monotone and the recurrence
    \[
        T(n) \geq a T(\lfloor n/b \rfloor) + f(n)
    \]
    holds for all $n \ge n\_0$ for some $a > 0$, $n\_0 > 1$ and $b > n\_0$. 
    Let also $f(n) \in \Omega(n^d)$ for some $d \ge 1$. The above recurrence 
    is a \textbf{lower master recurrence} with parameters $(a, n\_0, b, d)$.
\end{definition}

\begin{lemma}
    \label{lemma:big_o_geom}
    \lean{LowerMasterRec.O_geom}
    \leanok
    \uses{def:lower_master_rec, def:big_o}
    Let $T$ and $f$ form a lower master recurrence with parameters 
    $(a, n\_0, b, d)$. Then $T(n) \in O(n^{\log_b{a}} + 
    \sum_{k=0}^{\lfloor \log_b{n} \rfloor} (\frac{a}{b^d})^k n^d)$.
\end{lemma}

\begin{proof}
    \leanok
    \uses{lemma:big_o_trans, lemma:big_o_add}
    To eliminate ceilings in the recurrence, we substitute $T(n)$ with 
    $S(n) = T(n+b)$. Since $T$ is monotone, $T(n) \leq S(n) = T(n+b)$ holds 
    for all $n$. Therefore, an upper bound on $S$ is also an upper bound on 
    $T$. We must first show that $S$ follows the recurrence of $T$ without 
    ceilings. By the assumption that $b$ is a natural number such that $b > 1$, 
    we have the inequality 
    \begin{align*}
        \lceil \frac{n+b}{b} \rceil &\leq \frac{n+b}{b} + 1 \\
                                    &=    \frac{n}{b} + 2 \\
                                    &\leq \frac{n}{b} + b.
    \end{align*}
    Therefore, by monotonicity of $T$ we have 
    \begin{align*} 
        S(n)  &= T(n+b) \\
              &\leq a T(\frac{n}{b} + b) + f(n+b) \\
              &= a S(\frac{n}{b}) + f(n+b),
    \end{align*}
    which captures the wanted recurrence. Integer division here is defined as 
    the floor of real-number division.
    By substituting the inequality into itself repeatedly, we get
    \begin{align}
        \label{eq:s_rec}
        S(n) &\leq a S(\frac{n}{b}) + f(n + b) \\
             &\leq a S(\frac{n}{b}) + C n^d \\
             &\leq a^2 S(\frac{n}{b^2}) + C n^d + C \frac{a}{b^d} n^d \\
             &\leq a^3 S(\frac{n}{b^3}) + C (1 + \frac{a}{b^d} + 
                                            (\frac{a}{b^d})^2) n^d \\
             &\leq \dots \\
             &\leq a^k S(\frac{n}{b^k}) + C \sum_{i=0}^k 
                                                    (\frac{a}{b^d})^i n^d \\
    \end{align}
    Let $N$ be the integer such that for all $n \geq N \geq n\_0$, the 
    inequality $f(n) \leq C n^d$ holds. Such $N$ exists because 
    $f(n) \in O(n^d)$. We set $k = \lfloor \log_b{\frac{n}{N}} \rfloor$. 
    This choice of $k$ allows the inequality $n \geq N * b^k$ to hold for 
    large enough $n$. 

    Consider both sum parts on the right side of the Equation \ref{eq:s_rec}.
    For the first part, we notice that $n^{\log_b{a}} = a^{\log_b{n}}$.
    Expand $k$ in the exponent and apply monotonicity:
    \begin{align*}
        a^k &= a^{\lfloor \log_b{\frac{n}{N}} \rfloor} \\
            &\leq a^{\log_b{\frac{n}{N}}} \\
            &\leq a^{\log_b{n}}
    \end{align*}
    This implies $a^k \in O(n^{\log_b{a}})$. We also need $S(\frac{n}{b^k})$ to
    be bounded by a constant. We show that $S(\frac{n}{b^k}) \leq S(N*b)$.
    Since $S$ is monotone, this is equivalent to showing 
    $\frac{n}{b^k} \leq N*b$. We rewrite the left side as
    \begin{align*}
        \frac{n}{b^k} &= \frac{n}{b^{\lfloor \log_b{\frac{n}{N}} \rfloor}} \\
                      &= \frac{n}{b^{\lfloor \log_b{n} - \log_b{N} \rfloor}} \\
                      &= \frac{b^{\log_b{n}}}
                              {b^{\lfloor \log_b{n} - \log_b{N} \rfloor}} \\
                      &= b^{\log_b{n} - 
                            \lfloor \log_b{n} - \log_b{N} \rfloor}
    \end{align*}
    Then, rewrite the right side as $N*b = b^{\log_b{N} + 1}$. With both 
    sides written as exponents of $b$, we only need to prove
    \[\log_b{n} - \lfloor \log_b{n} - \log_b{N} \rfloor \leq \log_b{N} + 1.\]
    By swapping terms, we get
    \[\log_b{n} - \log_b{N} \leq \lfloor \log_b{n} - \log_b{N} \rfloor + 1,\]
    which holds for all real numbers. 

    For the second part, the inequality $k \leq \lfloor \log_b{n} \rfloor$ 
    holds by monotonicity of logarithms. As geometric sums are monotone in 
    the exponent, we get $\sum_{i=0}^k (\frac{a}{b^d})^i n^d \in 
    O(\sum_{i=0}^{\lfloor \log_b{n} \rfloor} (\frac{a}{b^d})^i n^d)$.
\end{proof}

\begin{theorem}
    \label{thm:lower_master_rec_big_o_of_lt}
    \lean{LowerMasterRec.O_of_lt}
    \leanok
    \uses{def:lower_master_rec, def:big_o}
    Let $T$ and $f$ form a lower master recurrence with parameters 
    $(a, n\_0, b, d)$, where $a < b^d$. Then $T(n) \in O(n^d)$.
\end{theorem}

\begin{proof}
    \leanok
    \uses{lemma:big_o_geom, lemma:big_o_trans, lemma:big_o_add}
    First, we apply Lemma \ref{lemma:big_o_geom}. Since $a < b^d$, we have 
    $\frac{a}{b^d} < 1$. By basic properties of geometric sums, we get
    \begin{align*}
        T(n) &\leq \sum_{i=0}^{\lfloor \log_b{n} \rfloor} 
                        (\frac{a}{b^d})^i n^d \\
             &\leq \frac{1}{1 - \frac{a}{b^d}} n^d,
    \end{align*}
    which proves the upper bound.
\end{proof}

\begin{theorem}
    \label{thm:lower_master_rec_big_o_of_eq}
    \lean{LowerMasterRec.O_of_eq}
    \leanok
    \uses{def:lower_master_rec, def:big_o}
    Let $T$ and $f$ form a lower master recurrence with parameters
    $(a, n\_0, b, d)$, where $a = b^d$. Then $T(n) \in O(n^d \log_b{n})$.
\end{theorem}

\begin{proof}
    \leanok
    \uses{lemma:big_o_geom, lemma:big_o_trans, lemma:big_o_add}
    After applying Lemma \ref{lemma:big_o_geom}, we note that $\log_b{a} = d$
    and then the proof boils down to showing that the geometric sum is bounded 
    by $\log_b{n}$. Since $\frac{a}{b^d} = 1$, the geometric sum equals
    $\lfloor \log_b{n} \rfloor$, which is obviously bounded by $\log_b{n}$.
\end{proof}

\begin{theorem}
    \label{thm:lower_master_rec_big_o_of_gt}
    \lean{LowerMasterRec.O_of_gt}
    \leanok
    \uses{def:lower_master_rec, def:big_o}
    Let $T$ and $f$ form a lower master recurrence with parameters
    $(a, n\_0, b, d)$, where $a > b^d$. Then $T(n) \in O(n^{\log_b{a}})$.
\end{theorem}

\begin{proof}
    \leanok
    \uses{lemma:big_o_geom, lemma:big_o_trans, lemma:big_o_add}
    After applying Lemma \ref{lemma:big_o_geom}, the left side of the sum if 
    trivially bounded by $n^{\log_b{a}}$. We are left with the right summand, 
    which we transform using an inequality involving the geometric sum:
    \begin{align*}
        \sum_{k=0}^{\lfloor \log_b{n} \rfloor} (\frac{a}{b^d})^k n^d
            &\leq \frac{1}{\frac{a}{b^d} - 1}
                    ((\frac{a}{b^d})^{\lfloor \log_b{n} \rfloor} - 1) n^d \\
            &\leq \frac{1}{\frac{a}{b^d} - 1}
                    ((\frac{a}{b^d})^{\log_b{n}} - 1) n^d \\
            &= \frac{1}{\frac{a}{b^d} - 1}
                    (b^{\log_b{\frac{a}{b^d}}})^{\log_b{n}} n^d \\
            &= \frac{1}{\frac{a}{b^d} - 1}
                    (b^{\log_b{n}})^{\log_b{\frac{a}{b^d}}} n^d \\
            &= \frac{1}{\frac{a}{b^d} - 1}
                    n^{\log_b{a} - d} n^d \\
            &= \frac{1}{\frac{a}{b^d} - 1}
                    \frac{n^{\log_b{a}}}{n^d} n^d \\
            &= \frac{1}{\frac{a}{b^d} - 1}
                    n^{\log_b{a}} \\
    \end{align*}
    Since $a > b^d$, $\frac{a}{b^d} > 1$ holds, so 
    $\frac{1}{\frac{a}{b^d} - 1} > 0$, which proves boundedness by 
    $n^{\log_b{a}}$.
\end{proof}


\begin{lemma}
    \label{lemma:big_omega_geom}
    \lean{UpperMasterRec.Î©_geom}
    \leanok
    \uses{def:upper_master_rec, def:big_omega}
    Let $T$ and $f$ form an upper master recurrence with parameters 
    $(a, n\_0, b, d)$. Then $T(n) \in 
    \Omega(\sum_{k=0}^{\lfloor \log_b{n} \rfloor} (\frac{a}{b^d})^k n^d)$.
\end{lemma}

\begin{proof}
    \leanok
    \uses{lemma:big_omega_trans}
    We consider the recurrence formula with ceilings replaced by floors. If the
    resulting inequality holds, then so does the master recurrence, so it 
    suffices to prove the lower bound for this inequality.

    By substituting the inequality into itself repeatedly, we get
    \begin{align}
        \label{eq:t_rec}
        T(n) &\leq a T(\frac{n}{b}) + f(n + b) \\
             &\leq a T(\frac{n}{b}) + C n^d \\
             &\leq a^2 T(\frac{n}{b^2}) + C n^d + C \frac{a}{b^d} n^d \\
             &\leq a^3 T(\frac{n}{b^3}) + C (1 + \frac{a}{b^d} + 
                                            (\frac{a}{b^d})^2) n^d \\
             &\leq \dots \\
             &\leq a^k T(\frac{n}{b^k}) + C \sum_{i=0}^k 
                                                    (\frac{a}{b^d})^i n^d \\
    \end{align}
    We set $k = \lfloor \log_b{n} \rfloor$. This choice of $k$ allows the 
    inequality $n \geq b^k$ to hold for large enough $n$. Here $C$ is a 
    positive constant such that $f(n) \geq C n^d$ for all $n \geq n\_0$. 
    Such a constant exists, because $f(n) \in \Omega(n^d)$ implies
    $f(n) \geq C\_0 n^d$ for some $C\_0 > 0$ for all $n \geq N$ for some $N$.
    For $n\_0 \leq n \leq N$, The argument is as follows. The set of natural 
    numbers between $n\_0$ and $N$ is finite, so the image of $f$ on this
    set has a maximal element $M$. We then have $f(n) \geq \frac{M}{N^d} n^d$.

    The second summand in the right side of Equation \ref{eq:t_rec} is
    trivially bounded above by 
    $\sum_{k=0}^{\lfloor \log_b{n} \rfloor} (\frac{a}{b^d})^k n^d$. This is 
    sufficient to prove the upper bound od $T(n)$ as the left summand is 
    non-negative.
\end{proof}

\begin{lemma}
    \label{lemma:upper_master_rec_big_omega}
    \lean{UpperMasterRec.Î©_pow_d}
    \leanok
    \uses{def:upper_master_rec, def:big_omega}
    Let $T$ and $f$ form an upper master recurrence with parameters 
    $(a, n\_0, b, d)$. Then $T(n) \in \Omega(n^d)$.
\end{lemma}

\begin{proof}
    \leanok
    \uses{lemma:big_omega_trans}
    Since $T(n) \geq f(n)$ for all $n \ge n\_0$, the lower bound follows 
    directly from $f(n) \in \Omega(n^d)$.
\end{proof}

\begin{theorem}
    \label{thm:upper_master_rec_big_omega_of_eq}
    \lean{UpperMasterRec.Î©_of_eq}
    \leanok
    \uses{def:upper_master_rec, def:big_omega}
    Let $T$ and $f$ form an upper master recurrence with parameters 
    $(a, n\_0, b, d)$ where $a = b^d$. Then $T(n) \in \Omega(n^d \log_b{n})$.
\end{theorem}

\begin{proof}
    \leanok
    \uses{lemma:big_omega_geom, lemma:big_omega_trans}
    By Lemma \ref{lemma:big_omega_geom}, it suffices to show that
    $\sum_{i=0}^{\lfloor \log_b{n} \rfloor} (\frac{a}{b^d})^i \in 
    \Omega(\log_b{n})$. Applying equality $a = b^d$, the sum simplifies to
    \begin{align*}
        \sum_{i=0}^{\lfloor \log_b{n} \rfloor} (\frac{a}{b^d})^i &= 
            \sum_{i=0}^{\lfloor \log_b{n} \rfloor} 1^i &=
            \lfloor \log_b{n} \rfloor.
    \end{align*}
\end{proof}

\begin{theorem}
    \label{thm:upper_master_rec_big_omega_of_gt}
    \lean{UpperMasterRec.Î©_of_gt}
    \leanok
    \uses{def:upper_master_rec, def:big_omega}
    Let $T$ and $f$ form an upper master recurrence with parameters 
    $(a, n\_0, b, d)$ where $a > b^d$. Then $T(n) \in \Omega(n^{\log_b{a}})$.
\end{theorem}

\begin{proof}
    \notready
    \uses{lemma:big_omega_geom, lemma:big_omega_trans}
    By Lemma \ref{lemma:big_omega_geom}, we need to show that 
    $\sum_{i=0}^{\lfloor \log_b{n} \rfloor} (\frac{a}{b^d})^i n^d
    \in \Omega(n^{\log_b{a}}). By $a > b^d$, we have 
    \begin{align*}
        \sum_{i=0}^{\lfloor \log_b{n} \rfloor} (\frac{a}{b^d})^i n^d 
        &\geq (a b^{-d} - 1)^{-1}
            ((a b^{-d})^{\lfloor \log_b{n} \rfloor} - 1) n^d \\
        &\geq 2^{-1} (a b^{-d} - 1)^{-1}
            (a b^{-d})^{\lfloor \log_b{n} \rfloor} n^d \\
        &\geq 2^{-1} (a b^{-d} - 1)^{-1} (a b^{-d})^{\log_b{n} - 1} n^d \\
        &\geq 2^{-1} a^{-1} b^d (a b^{-d} - 1)^{-1} a^{\log_b{n}} 
            (b^{\log_b{n} - 1})^{-d} n^d \\
        &\geq 2^{-1} a^{-1} b^d (a b^{-d} - 1)^{-1} n^{\log_b{a}} n^{-d} n^d \\
        &\geq 2^{-1} a^{-1} b^d (a b^{-d} - 1)^{-1} n^{\log_b{a}},
    \end{align*}
    which proves the bound.
\end{proof}


\begin{corollary}
    \label{thm:master_rec_theta_of_lt}
    \lean{MasterRec.Î_of_lt}
    \leanok
    \uses{def:upper_master_rec, def:lower_master_rec, def:theta}
    Let $T$ and $f$ form an upper and lower master recurrence with parameters 
    $(a, n\_0, b, d)$ where $a < b^d$. Then $T(n) \in \Theta(n^d)$.
\end{corollary}

\begin{proof}
    \leanok
    \uses{thm:big_o_and_omega_iff_theta, thm:lower_master_rec_big_o_of_lt,
        thm:upper_master_rec_big_omega}
    By Theorem \ref{thm:big_o_and_omega_iff_theta}, it suffices to show
    lower and upper bounds for $T$, which we already proved in Theorem
    \ref{thm:lower_master_rec_big_o_of_lt} and Lemma
    \ref{lemma:upper_master_rec_big_omega}.
\end{proof}

\begin{corollary}
    \label{thm:master_rec_theta_of_eq}
    \lean{MasterRec.Î_of_eq}
    \leanok
    \uses{def:upper_master_rec, def:lower_master_rec, def:theta}
    Let $T$ and $f$ form an upper and lower master recurrence with parameters 
    $(a, n\_0, b, d)$ where $a = b^d$. Then $T(n) \in \Theta(n^d \log_b{a})$.
\end{corollary}

\begin{proof}
    \leanok
    \uses{thm:big_o_and_omega_iff_theta, thm:lower_master_rec_big_o_of_eq,
        thm:upper_master_rec_big_omega_of_eq}
    By Theorem \ref{thm:big_o_and_omega_iff_theta}, it suffices to show
    lower and upper bounds for $T$, which we already proved in Theorems
    \ref{thm:lower_master_rec_big_o_of_eq} and 
    \ref{thm:upper_master_rec_big_omega_of_eq}.
\end{proof}

\begin{corollary}
    \label{thm:master_rec_theta_of_gt}
    \lean{MasterRec.Î_of_gt}
    \leanok
    \uses{def:upper_master_rec, def:lower_master_rec, def:theta}
    Let $T$ and $f$ form an upper and lower master recurrence with parameters 
    $(a, n\_0, b, d)$ where $a > b^d$. Then $T(n) \in \Theta(n^{\log_b{n}})$.
\end{corollary}

\begin{proof}
    \leanok
    \uses{thm:big_o_and_omega_iff_theta, thm:lower_master_rec_big_o_of_gt, 
        thm:upper_master_rec_big_omega_of_gt}
    By Theorem \ref{thm:big_o_and_omega_iff_theta}, it suffices to show
    lower and upper bounds for $T$, which we already proved in Theorems
    \ref{thm:lower_master_rec_big_o_of_gt} and 
    \ref{thm:upper_master_rec_big_omega_of_gt}.
\end{proof}
